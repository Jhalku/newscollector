{% extends 'rental/base.html' %}
{% block content %}
<h1>Find Spaces You Can Actually Book</h1>
<form class="search" method="get">
    <input type="text" name="city" placeholder="City" value="{{ request.args.get('city', '') }}">
    <select name="space_type">
        <option value="">Any type</option>
        {% for t in ['Apartment', 'Office', 'Shop', 'Warehouse', 'Studio', 'Villa'] %}
        <option value="{{ t }}" {% if request.args.get('space_type') == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
    </select>
    <input type="number" name="guests" min="1" placeholder="Guests" value="{{ request.args.get('guests', '') }}">
    <input type="number" step="0.01" name="min_price" placeholder="Min price/day" value="{{ request.args.get('min_price', '') }}">
    <input type="number" step="0.01" name="max_price" placeholder="Max price/day" value="{{ request.args.get('max_price', '') }}">
    <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
    <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
    <button type="submit">Search</button>
</form>

<div class="grid">
    {% for listing in listings %}
    <article class="card">
        <img src="{{ listing['image_url'] or 'https://images.unsplash.com/photo-1494526585095-c41746248156?auto=format&fit=crop&w=1200&q=80' }}" alt="{{ listing['title'] }}">
        <h3>{{ listing['title'] }}</h3>
        <p>{{ listing['city'] }}{% if listing['state'] %}, {{ listing['state'] }}{% endif %} | {{ listing['space_type'] }}</p>
        <p class="price">USD {{ '%.2f'|format(listing['price_per_day']) }} / day</p>
        <p>Up to {{ listing['max_guests'] }} guests | Min {{ listing['min_stay_days'] }} day(s)</p>
        <p>{{ listing['description'][:120] }}{% if listing['description']|length > 120 %}...{% endif %}</p>
        {% set amenities = parse_amenities(listing['amenities']) %}
        {% if amenities %}
        <p class="amenities">{{ amenities[:4]|join(' â€¢ ') }}</p>
        {% endif %}
        <p class="rating">
            {% if listing['review_count'] %}
            {{ listing['avg_rating'] }} / 5 ({{ listing['review_count'] }} reviews)
            {% else %}
            New listing
            {% endif %}
        </p>
        <small>Owner: {{ listing['owner_name'] }}</small>
        <a class="btn" href="{{ url_for('listing_detail', listing_id=listing['id']) }}">View</a>
    </article>
    {% else %}
    <p>No listings found. Try changing filters or add a new listing.</p>
    {% endfor %}
</div>
{% endblock %}
